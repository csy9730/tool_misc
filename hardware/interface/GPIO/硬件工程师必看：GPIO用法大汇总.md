# 硬件工程师必看：GPIO用法大汇总

[![从事嵌入式11年](https://pic2.zhimg.com/v2-60864fe7b90c69de064759203396230c_xs.jpg?source=172ae18b)](https://www.zhihu.com/people/chen-xian-sheng-10-25)

[从事嵌入式11年](https://www.zhihu.com/people/chen-xian-sheng-10-25)





111 人赞同了该文章

**GPIO是什么？**


字面意思看，GPIO=General Purpose Input Output，通用输入输出。有时候简称为“IO口”。通用，就是说它是万金油，干什么都行。输入输出，就是说既能当输入口使用，又能当输出口使用。端口，就是元器件上的一个引脚。怎么用？写软件控制。



**总结：GPIO就是芯片上的一根干啥都行的引脚。**



讲了这么多，相信不懂的人还是一头雾水，咱们对着案例看看GPIO怎么用至于上拉、下拉、悬空、高阻、开漏、推挽之类的概念，可以以后再慢慢琢磨。



**GPIO的简单用法**



**输出控制信号**

![img](https://pic4.zhimg.com/80/v2-c3aec2292f67520e9e1d1d74b0551267_1440w.jpg)



*GPIO控制LED灯的开关*



**GPIO用来做开关控制**，是最常见的应用场景。



如上图，P21这个GPIO口，输出1的时候，LED403点亮，输出0或者没有输出的时候，LED403熄灭。



GPIO口是怎么被控制的呢？通过软件代码。需要亮灯的时候调用GPIO口拉高的函数，需要熄灯的时候调用GPIO拉低的函数，即可实现控制。函数的操作，最终变成了向这个GPIO的硬件寄存器写入数据，硬件的状态会跟随寄存器的数据改变而改变。



**硬件寄存器在这里可以理解为一个电子开关**，好比你告诉家里的保姆说“去吧客厅的灯关上”，他就走过去按动灯的开关，然后灯就灭了。你下的这个指令的动作相当于调用了GPIO操作的函数，保姆去按开关这个动作相当于函数配置寄存器。



当然你也可以直接去按这个开关（直接操作寄存器），这个做法虽然能工作，但是在代码设计中是不符合规范的。后续修改中很容易导致误操作。实际操作中需要预先初始化，配置GPIO的参数，把寄存器建立接口给其他进程调用等软件类的操作，这里就不详述了。



**输入中断信号**

![img](https://pic2.zhimg.com/80/v2-e642cea9186e6eb4efb44832482191d9_1440w.jpg)

*重力传感器输出中断信号给MCU的GPIO口*



G-sensor，也叫做重力传感器/加速度传感器/运动传感器，检测设备是否在运动的。咱们平时用的蓝牙手环的计步器主要就是根据G-sensor采样回来的运动数据计算而来的。



设备不动的时候，G-sensor和MCU都是休眠状态以节省电量。



设备动一动，G-sensor感受到了就被唤醒了，就往中断口上（GSENSOR_INT）发一个高电平信号，MCU感受到这个中断口的电平从低变成高了，就退出休眠开始正常运行。



然后MCU就通过I2C数据接口读取G-sensor里的数据。



**如何理解中断呢？**你正在睡觉，突然有人来找你，他就要先把你摇醒才行。这就是把你的睡眠中断了，让你从睡眠中被唤醒（如同上述例子）。



同样，如果你正在看电影，突然手机铃声响了，一看是女朋友来电话了，就要把电影暂停，保留电影当前的播放位置，然后去接女朋友的电话。接完了电话，再继续从之前的播放位置开始播放。



这个电话就是中断信号，保存电影位置就是中断响应前的状态入栈，接电话的过程就是中断服务程序，挂了电话继续播放就是中断的状态出栈。



可能有人会说，为什么多此一举，**G-sensor不能直接把数据发送给MCU么？**这是因为I2C只能由主设备主动发起数据传输的请求，从设备是不能主动发送数据的（只能任由主设备过来读取数据）。关于I2C协议的内容，请见相关文章。



但凡I2C接口且持续工作的设备，都需要有一个中断输出，用来告诉主机“我已经准备好数据了，你快点过来取走吧”。



**用GPIO做中断，还需要特别特别注意一条：**如果选择这个中断口来唤醒系统，那一定要对照芯片规格书看清楚，选择的中断口能不能唤醒系统？



对于大部分单片机，几乎每一个中断口都可以唤醒系统，但对于高主频的处理器，如手机和平板电脑的，并不是所有的GPIO都可以配置成中断，也不是所有的中断都能唤醒系统。



如果选择了一个不能唤醒系统的中断口做上述示例，一旦MCU进入休眠，外设就失效了。



**用作按键输入**

![img](https://pic3.zhimg.com/80/v2-da75b73bd38bce6b75998df6b2cf4ec6_1440w.jpg)



*GPIO做按键检测*



**按键严格来讲也是个中断。**GPIO口默认状态是低电平，按键按下后被拉到高电平，此时系统能够检测到中断，判定为按键按下。



等到按键释放了，GPIO口检测到电压回归低电平，就判定为按键松开了。这种做法是单片机上比较常见的做法。在智能一些的硬件平台上，往往会有独立的硬件按键接口（非GPIO口），在芯片内部加入按键控制器，通过硬件实现按键的去抖、双击和长按判断。



对于单片机，一旦被按键触发之后，内部就开始跑程序，每隔几个毫秒读取一次按键状态，判断按键是否被释放。通过软件实现去抖、双击和长按的功能。



图上的电容，用处是滤除外部干扰，避免被误触发，同时起到一定的按键去抖作用。图上的TVS管，是为了防止静电进入CPU。



可能会有人问，**按键按下就是按下了，为什么会抖动？**



因为按键都是机械式的，两个金属片在接触的瞬间，从微秒级的时间段来看，会存在接触-断开-再接触这样的轻微的抖动。直到两个金属片牢牢的接触到一起之后，抖动才会消失。所谓按键去抖动，就是通过延时来消除掉接触再断开这种异常状态的。



如果GPIO口不够，但是**需要做多个按键的检测**，也可以把按键配置成为ADC，通过不同按键产生不同的电压，来利用一个ADC口检测到不同的键值。这个做法通常用于手机3.5mm有线耳机上的3个按键的检测。

**GPIO的高阶应用**



GPIO除了简单的输入输出之外，还可以做一些**相对复杂的操作**，例如模拟I2C或SPI数据线、ADC电压检测、输出PWM波形等。

这些功能有些可以直接配置成硬件接口，也可以通过软件来模拟波形。

**用作I2C接口**

![img](https://pic3.zhimg.com/80/v2-5c7818feab98b616fc62a5b910842da2_1440w.jpg)



*GPIO用作I2C数据总线*

![img](https://pic3.zhimg.com/80/v2-fb0a95abffaa31ae554ce0088ddc81a6_1440w.jpg)

*I2C时序图*



**I2C是智能硬件电路上最常用的数据传输总线**，只需要2根线，就能够挂载多个从设备，能够双向传输，最大速度可达400Kbps，非常适合传输控制指令和小量数据。



平时大家用的G-sensor传感器、光距离传感器、电容触摸屏、LED灯控制器、摄像头的控制命令等，几乎都是I2C接口的。



GPIO口用作I2C，算是GPIO传数据的最常用的方式。如果芯片内部自带I2C控制器，可以直接配置GPIO切换到硬件I2C上。例如单片机几乎都可以这么做。



如果芯片内部的I2C接口不够用，**还可以通过软件控制GPIO口拉高拉低来模拟I2C的波形和时序**，照样可以当作I2C使用。



同样的模拟数据线的做法，还可以用GPIO来模拟SPI。只要是带时钟的低速同步数据线，都可以用GPIO口来模拟。



但是GPIO口不能用来模拟UART串口。因为UART没有时钟线，需要非常精准的按照约定的时间间隔输出波形，软件定时器不准，硬件定时器占用系统资源多，所以很难实现。



**PWM输出**

![img](https://pic4.zhimg.com/80/v2-dbb631a7355cb70473a33e72a842a307_1440w.jpg)

*GPIO输出PWM波控制蜂鸣片*

![img](https://pic2.zhimg.com/80/v2-e316a2ae58290a44f02745a561231b49_1440w.jpg)

*不同占空比的PWM波形*



**GPIO口输出PWM波**，跟当作I2C使用的性质上是一样的。控制GPIO口 定时拉高拉低，就可以输出PWM波形。



如上图，就是通过PWM来控制外部升压电路，驱动蜂鸣片发出声音的。PWM还可以用于控制LED灯的调光，改变PWM输出的占空比，调节灯光亮度



**ADC采样**



![img](https://pic3.zhimg.com/80/v2-67dbce548d21746a2cc8a1cf8ddb2996_1440w.jpg)

*GPIO用作ADC采样，采集电池电压*

![img](https://pic4.zhimg.com/80/v2-15a75234eadc9fb4c62b7fdb482069a7_1440w.jpg)

*电池分压后给ADC采样*



ADC,Analog-to-Digital Converter，把模拟信号转换成数字信号。ADC的应用范围很广，麦克风音频数据的采样、电压电流信号的采样、模拟传感器输出的数据的量化等。



受限于精度、量程、采样速度等，GPIO的ADC一般不做太复杂的应用，大部分时候只做电压采集。



如上图，把GPIO口配置成为ADC模式，采集电池电压，用于做电池电量显示。这个做法只适合做简单的电池电压显示，如果要做类似智能手机的百分之一精度的电池电量管理，还需要外加更高精度的ADC和电池补偿算法。



GPIO做ADC，最常遇到的问题是：



**一，不是所有的GPIO口可以做ADC使用，一定要看清楚规格书！**

**二，ADC有电压域限制的，3V供电的ADC测量不到超过3V的电压。**例如上面第一张图，MCU用3V电池供电，此时GPIO/ADC的供电电压是3V，最大量程也是3V，可以测量到电池电压。而第二张图锂离子电池电压是4.2V，MCU供电是3V，GPIO/ADC工作电压也是3V，就量不到这么高的电压了。超出量程测量出来的都是一样的。因此利用电阻分压，把4.2V的电池电压折半降低到2.1V，给3V量程的ADC使用。更多交流分享私我



发布于 2019-08-28



赞同 111