# I2C通信协议介绍

[![不撑了不撑了](https://pic2.zhimg.com/v2-a988850ebbe6aea681d8ecab03dfbe58_xs.jpg?source=172ae18b)](https://www.zhihu.com/people/cyhluc)

[不撑了不撑了](https://www.zhihu.com/people/cyhluc)





26 人赞同了该文章

I2C通讯协议(Inter－Integrated Circuit)引脚少，硬件实现简单，可扩展性强，不需要USART、CAN等通讯协议的外部收发设备，现在被广泛地使用在系统内多个集成电路(IC)间的通讯。

实现I2C需要两根信号线完成信息交换，SCL时钟信号线，SDA数据输入/输出线。它属于同步通信，由于输入输出数据均使用一根线，因此通信方向为半双工。

·I2C最少只需要两根线，和异步串口类似，但可以支持多个slave设备。一个I2C理论上最多可挂载127个设备，但除去保留地址，最多可挂载112个设备。

·和SPI不同的是，I2C可以支持multi-master系统，允许有多个master并且每个master都可以与所有的slaves通信（master之间不可通过I2C通信，并且每个master只能轮流使用I2C总线）。

·I2C的数据传输速率位于串口和SPI之间，大部分I2C设备支持100KHz和400KHz模式。

使用I2C传输数据会有一些额外消耗：每发送8bits数据，就需要额外1bit的元数据（ACK或NACK）。

·I2C支持双向数据交换，由于仅有一根数据线，故通信是半双工的。硬件复杂度也位于串口和SPI之间，而软件实现可以相当简单。

## **I2C物理层**

![img](https://pic2.zhimg.com/80/v2-13f2e9e79052fab366696994d2cf85d9_1440w.jpg)

·它是一个支持设备的总线。“总线”指多个设备共用的信号线。在一个I2C通讯总线中，可连接多个I2C通讯设备，支持多个通讯主机及多个通讯从机。

·一个I2C总线只使用两条总线线路，一条双向串行数据线(SDA)，一条串行时钟线(SCL)。数据线即用来表示数据，时钟线用于数据收发同步。

·每个连接到总线的设备都有一个独立的地址，主机可以利用这个地址进行不同设备之间的访问。

·总线通过上拉电阻接到电源。当I2C设备空闲时，会输出高阻态，而当所有设备都空闲，都输出高阻态时，由上拉电阻把总线拉成高电平。

·多个主机同时使用总线时，为了防止数据冲突，会利用仲裁方式决定由哪个设备占用总线。

·具有三种传输模式：标准模式传输速率为100kbit/s，快速模式为400kbit/s，高速模下可达3.4Mbit/s，但目前大多I2C设备尚不支持高速模式。

## **I2C协议层**

以主机向从机写数据为例，其基本结构如图所示，依次为：
**起始信号——从机地址——读写信号——数据位——应答位——… … ——停止位**

![img](https://pic2.zhimg.com/80/v2-1731c80f7c957ba510ac073e50483705_1440w.jpg)

起始信号(S)：当 SCL 线是高电平时，SDA 线从高电平向低电平切换；停止信号(P)：当 SCL 是高电平时，SDA 线由低电平向高电平切换。

![img](https://pic3.zhimg.com/80/v2-2e7da749509983984c037ea57c151222_1440w.jpg)

帧地址：I2C总线上的每个设备都有自己的独立地址，主机发起通讯时，通过SDA信号线发送设备地址(SLAVE_ADDRESS)来查找从机。I2C协议规定设备地址可以是7位或10位，实际中7位的地址应用比较广泛。

I2C使用SDA信号线来传输数据，使用SCL信号线进行数据同步。SDA数据线在SCL的每个时钟周期传输一位数据。传输时，SCL为高电平的时候SDA表示的数据有效，即此时的SDA为高电平时表示数据“1”，为低电平时表示数据“0”。当SCL为低电平时，SDA的数据无效，一般在这个时候SDA进行电平切换，为下一次表示数据做好准备。

I2C的数据和地址传输都带响应。响应包括“应答(ACK)”和“非应答(NACK)”两种信号。

作为数据接收端时，当设备(无论主从机)接收到I2C传输的一个字节数据或地址后，若希望对方继续发送数据，则需要向对方发送“应答(ACK)”信号，发送方会继续发送下一个数据；若接收端希望结束数据传输，则向对方发送“非应答(NACK)”信号，发送方接收到该信号后会产生一个停止信号，结束信号传输。

## **I2C功能框图剖析**

![img](https://pic2.zhimg.com/80/v2-81bbae342cab337627cf272b44db67b5_1440w.jpg)

**时钟控制逻辑：**

SCL线的时钟信号，由I2C接口根据时钟控制寄存器(CCR)控制，控制的参数主要为时钟频率。配置I2C的CCR寄存器可修改通讯速率相关的参数。

可选择I2C通讯的“标准/快速”模式，这两个模式分别I2C对应100/400Kbit/s的通讯速率。

在快速模式下可选择SCL时钟的占空比，可选Tlow/Thigh=2或Tlow/Thigh=16/9模式，我们知道I2C协议在SCL高电平时对SDA信号采样，SCL低电平时SDA准备下一个数据，修改SCL 的高低电平比会影响数据采样，但其实这两个模式的比例差别并不大，若不是要求非常严格，随便选就可以了。

CCR寄存器中还有一个12位的配置因子CCR，它与I2C外设的输入时钟源共同作用，产生SCL时钟，STM32的I2C外设都挂载在APB1总线上，使用APB1的时钟源PCLK1，SCL信号线的输出时钟公式如下：

![img](https://pic1.zhimg.com/80/v2-824476a9d0304a01ac3f4b15190abd08_1440w.jpg)

例如，我们的PCLK1=36MHz，想要配置400Kbit/s的速率，计算方式如下：

PCLK时钟周期：TPCLK1 = 1/36000000

目标SCL时钟周期：TSCL = 1/400000

SCL时钟周期内的高电平时间：THIGH = TSCL/3

SCL时钟周期内的低电平时间：TLOW = 2*TSCL/3

计算CCR的值：CCR = THIGH/TPCLK1 = 30

计算结果得出CCR为30，向该寄存器位写入此值则可以控制IIC的通讯速率为400KHz，其实即使配置出来的SCL时钟不完全等于标准的400KHz，IIC通讯的正确性也不会受到影响，因为所有数据通讯都是由SCL协调的，只要它的时钟频率不远高于标准即可。

**数据控制逻辑：**

I2C的SDA信号主要连到数据移位寄存器上，数据移位寄存器的数据来源及目标是数据寄存器(DR)、地址寄存器(OAR)、PEC寄存器以及SDA数据线。当向外发送数据的时候，数据移位寄存器以“数据寄存器”为数据源，把数据一位一位地通过SDA信号线发送出去；当从外部接收数据的时候，数据移位寄存器把SDA信号线采样到的数据一位位地存储到“数据寄存器”中。若使能了数据校验，接收到的数据会经过PCE计算器运算，运算结果存储在“PEC 寄存器”中。当STM32的I2C工作在从机模式的时候，接收到设备地址信号时，数据移位寄存器会把接收到的地址与STM32的自身的“I2C地址寄存器”的值作比较，以便响应主机的寻址。STM32的自身I2C地址可通过修改“自身地址寄存器”修改，支持同时使用两个I2C设备地址，两个地址分别存储在OAR1和OAR2中。

**整体控制逻辑：**

整体控制逻辑负责协调整个I2C外设，控制逻辑的工作模式根据我们配置的“控制寄存器(CR1/CR2)”的参数而改变。在外设工作时，控制逻辑会根据外设的工作状态修改“状态寄存器(SR1和SR2)”，我们只要读取这些寄存器相关的寄存器位，就可以了解I2C的工作状态。除此之外，控制逻辑还根据要求，负责控制产生I2C中断信号、DMA请求及各种I2C的通讯信号(起始、停止、响应信号等)。

## **通讯过程**

使用I2C外设通讯时，在通讯的不同阶段它会对“状态寄存器(SR1及SR2)”的不同数据位写入参数，我们通过读取这些寄存器标志来了解通讯状态。

**从发送模式：**

![img](https://pic4.zhimg.com/80/v2-933083b14613c8db15b7a9801e7bbf97_1440w.jpg)

**从接收模式：**

![img](https://pic4.zhimg.com/80/v2-cf186fae58138d2b2267c804ae49cfb3_1440w.jpg)



之后会基于STM32和LM75A传感器（I2C）继续介绍怎样配置和使用I2C，包括使用I2C写入和读取数据。

[撑腰会儿：基于STM32使用I2C读取传感器数据7 赞同 · 0 评论文章](https://zhuanlan.zhihu.com/p/137668294)



编辑于 2020-05-01 16:54

通讯协议

嵌入式系统

STM32

赞同 26

添加评论

分享