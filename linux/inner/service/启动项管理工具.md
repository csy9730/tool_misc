# 启动项管理工具


有以下的启动项设置方式

* systemctl (systemd)  推荐使用，包含chkconfig和service的功能。
* service  可以开启关闭服务，通过管理 /etc/init.d  实现。
* /etc/init.d linux启动的核心机制。
* chkconfig  可以添加/移除启动项，centos专用
* update-rc.d 可以添加/移除启动项，debian专用？标记弃用
* superviser  (pypi) 



以下功能相似，都能设置启动项/服务
``` bash
service sshd start # 开始sshd服务

systemctl start sshd # 开始sshd服务

/etc/init.d/sshd start # 开始sshd服务

chkconfig --add ssh  # 添加sshd服务到启动项
```


/usr/sbin/service 是bash脚本，service功能是调用/bin/systemctl，生成/etc/init.d/sshd 文件 或者 /etc/init/ssh.conf

systemctl（/bin/systemctl）的功能是：在/etc/systemd/system目录添加一个符号链接，指向/usr/lib/systemd/system里面的httpd.service文件。
例如：/usr/lib/systemd/system/sshd.service 

注意：在CentOS7.0后，不再使用service,而是systemctl 。centos7.0是向下兼容的，也是可以用service.
/sbin/chkconfig 是bash脚本


在/etc/init.d的可执行程序的优先级会高于/etc/systemd/system/下的service文件，如果同时存在的话。

`serivice xxxx start|stop|restart `相当于是对/etc/init.d下的xxxx的封装，相当于是一个管理命令，实际执行的是`/etc/init.d`下的可执行程序。如果/etc/init.d下没有该服务的可执行程序，则使用service文件


## tools

### chkconfig



将启动文件cp到 /etc/init.d/或者/etc/rc.d/init.d/（前者是后者的软连接）下

vim 启动文件，文件前面务必添加如下三行代码，否侧会提示chkconfig不支持
``` bash
#!/bin/sh  
#chkconfig: 35 20 80 分别代表运行级别，启动优先权，关闭优先权，此行代码必须
#description: http server（自己随便发挥）//两行都注释掉！！！，此行代码必须
```

``` bash
update-rc.d test defaults 95 # 数字95是脚本的启动顺序号，启动顺序值越小越优先启动
chkconfig --add 脚本文件名  # 操作后就已经添加了

# 从开机列表中删除该启动项
chkconfig --del  test 
update-rc.d  -f  test  remove
```
#### help
```
➜  ~ chkconfig --help
chkconfig version 1.7.6 - Copyright (C) 1997-2000 Red Hat, Inc.
This may be freely redistributed under the terms of the GNU Public License.

usage:   chkconfig [--list] [--type <type>] [name]
         chkconfig --add <name>
         chkconfig --del <name>
         chkconfig --override <name>
         chkconfig [--level <levels>] [--type <type>] <name> <on|off|reset|resetpriorities>
```


### service

#### help
 ```
 service -h    
Usage: service < option > | --status-all | [ service_name [ command | --full-restart ] ]
```

### superviser

先安装 supervisor
```
sudo apt install supervisor
```

#### frps  demo
创建 supervisor frps 配置文件
在 /etc/supervisor/conf.d 创建 frp.conf
``` ini
[program:frp]
command = /root/frp/frps -c /root/frp/frps.ini
autostart = true
```
command应该是你放置frp软件的位置。

查看状态
``` bash
# 重启supervisor
sudo systemctl restart supervisor
# 查看supervisor运行状态
sudo supervisorctl status
```


### systemctl

对于那些支持 Systemd 的软件，安装的时候，会自动在`/usr/lib/systemd/system`目录添加一个配置文件。

如果你想让该软件开机启动，就执行下面的命令（以httpd.service为例）。

`$ sudo systemctl enable httpd`
上面的命令相当于在/etc/systemd/system目录添加一个符号链接，指向/usr/lib/systemd/system里面的httpd.service文件。

这是因为开机时，Systemd只执行/etc/systemd/system目录里面的配置文件。这也意味着，如果把修改后的配置文件放在该目录，就可以达到覆盖原始配置的效果。

#### frps demo
/usr/lib/systemd/system/frps.service
``` ini
[Unit]
Description=frps
After=network.target

[Service]
TimeoutStartSec=30
ExecStart=/usr/local/bin/frps -c /etc/frp/frps.ini
ExecStop=/bin/kill $MAINPID

[Install]
WantedBy=multi-user.target
```

``` bash
sudo systemctl enable frps
sudo systemctl start frps
sudo systemctl status frps
```
### update-rc.d
略

## 启动过程


linux启动步骤

（1）打开计算机电源，开始读取bios并进行主机的自我测试
（2）通过bios取得第一个可开机设备，读取主要开机区（MBR）取得启动装载程序；
（3）取得kernel并加载到内存且检测系统硬件
（4）内核主动调用init进程，init进程是Linux的根进程，所有的系统进程都是它的子进程。
（5）init进程开始执行系统初始化，init 进程读取 /etc/inittab 文件中的信息，并进入预设的运行级别。通常情况下 /etc/rcS.d/ 目录下的启动脚本首先被执行，然后是/etc/rcN.d/ 目录（/etc/rc.d/rc.sysinit或rc-sysinit.conf）
（6）依据init的设置进行启动（/etc/rc.d/rc[0-6].d/*）
（7）加载本机设置，启动登录管理器，等待用户登录

init程序启动之后，会读取/etc/inittab文件，来决定系统的运行级别，Linux系统的运行级别有7中，从0-6
* 0 - 关机模式（千万不要把initdefault设置为0 ，要不然你永远开不了机）
* 1 - 单用户模式 （此模式相当于救援模式，内核损坏，root忘记密 等可以使用此模式进行恢复 。想当于windows下的安全模式）
* 2 - 多用户，但是没有NFS
* 3 - 完全多用户模式 （文本命令行界面，一般服务器都是此模式）
* 4 - 保留未使用
* 5 - 图形桌面（系统启动之后会进入到图形化桌面系统中）
* 6 - 重新启动（千万不要把initdefault设置为6 ）