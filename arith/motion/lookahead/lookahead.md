# lookahead



- 连续运动
    - 反向
    - 梯形规划/s型规划
    - 动态变速 
- 前瞻运动
    - 反向
    - 梯形规划/s型规划
    - 动态变速 



- 梯形速度前瞻
    - 无需考虑初始加速度
    - 支持分立松弛算法
    - 支持归并松弛算法
- s型速度前瞻
    - 需考虑初始加速度
    - 支持分立松弛算法
    - 支持归并松弛算法
- 混合速度前瞻


#### 速度规划的多重分组


- 单个速度规划
- 同类型的速度规划组，间隔点的加速度可以非0
    - 同参数的速度规划组
      - 合并速度规划 [[T1,T2,T3],[T4,T5], [T6]]
      - 不可合并速度规划 [[T1],[T2],[T3]]
    - 不同参数的速度规划组
      - 不可合并速度规划
      - 可合并速度规划 ?
- 不同类型的速度规划组 间隔点的加速度都为0
    - [[[T1,T2],[T3]],[[S1,S2,S3]],[[T4],[T5]],[[S4]]]
- 不同站点的速度规划组 站点的速度，加速度都为0

需要的子算法
- 前瞻&后顾
    - 前瞻速度算法
    - 后顾速度算法
    - 前瞻后顾算法
- 速度敏感点搜索算法
    - 限速极小值搜索（站点）
    - 前瞻后顾最大值 


##### 速度敏感点
使用速度敏感点，可以避免反复的前瞻后顾算法，避免回溯。

怎么得到速度敏感点？

- 限速站点
- 小线段点
##### 站点搜索
- 站点搜索识别

区分左站点和右站点


### 小线段前瞻
- 小线段前瞻 不能到达最大匀速
- 长线段前瞻 可以到达最大匀速



如何区分小线段和长线段？

#### 公式推导

$$
S_1,S_2,..., S_N\\
v_0,v_1,...,v_N\\
V_0,V_1, ...,V_N\\
A_1, A_2, ..., A_N\\
D_1,D_2, ..., D_N\\
V_{m,1},V_{m,2},...,V_{m,N},\\
$$

##### 速度归并
归并标记，1为头，0为腹或尾。
用于记录多个速度规划合并成一个规划的情况，路程也变成总和。
$$
M_1,M_2, ..., M_N\\
$$

梯形速度规划，需要考虑速度，不考虑速度也能解决问题。
s形速度规划，需要考虑速度和加速度，速度归并更加复杂。

##### 前瞻速度

$$
v_{i,p+} = \sqrt{v_i^2+2A_iS_i}\\
v_{i,p-} = \sqrt{v_i^2-2D_iS_i}\\
$$
2
$$
v_{i,p-} \le v_i \le v_{i,p+}
$$
##### 后顾速度
$$
v_{i,n+} = \sqrt{v_{i+1}^2+2D_{i+1}S_{i+1}}\\
v_{i,n-} = \sqrt{v_{i+1}^2-2A_{i+1}S_{i+1}}\\
$$

2
$$
v_{i,n-} \le v_i \le v_{i,n+}
$$
##### 前瞻

##### 后顾减速
后段距离充分大，后顾可以任意减速，可以从最大限速减速到0。
$$
\sqrt{2D_{i+1}S_{i+1}}>V_{m,i}
$$

##### 后顾加速
后段距离充分大，后顾可以任意加速，可以从0加速到最大限速。
$$
\sqrt{2A_{i+1}S_{i+1}}>V_{m,i+1}
$$


#### 总结

- 距离限速
  - 前段限速上限
  - 前段限速下限
  - 后段限速上限
  - 后段限速下限
- 站点限速
  - 当前站点最大限速
- 最大最小速度限速
  - 最大速度限速
  - 最小速度限速

三个速度，总有一个最大值，最小值。默认情况使用最大最小速度限速。

- **无限速**：站点最大限速，前后段限速上限都大于最大速度限速，则该节点无需考虑，可以删除该节点。
- **站点最大限速**小于最大限速，前段限速上限，后段限速上限都大于最大速度限速。
- **前后段限速上限**都小于最大速度限速，站点最大限速大于最大限速。
- **双重限速**：站点最大限速，前段限速上限，后段限速上限都小于最大速度限速。
    - 站点最大限速最小
    - 前后段限速上限最小
- 站点最大限速，前后段限速上限**不明确大于**最大速度限速


- 距离限速
  - 前段距离任意减速
  - 前段距离任意加速
  - 后段距离任意减速
  - 后段距离任意加速


#### 离线算法和在线算法
- 离线算法，一次性得到所有速度规划，开始一次规划
- 在线算法，逐次得到若干速度规划，开始多次规划。
    - 单段合并
    - 多段合并

考虑设计多层规划算法

- 路程无关点过滤
- 速度敏感点搜索
    - 路程敏感点搜索
    - 站点搜索
- 加减速标记
    - 加速 1
    - 减速 4
    - 匀速 2
    - 加速匀速减速 7
- 能达速度计算。
    - 前瞻速度
    - 后顾速度
- 小线段归并，分组 
    - try
    - 去除失败的分组。
- 输出


- 梯形运动 支持 通过路程合并，快速计算前瞻后顾速度。
- s型运动 不支持 通过路程合并快速计算前瞻后顾速度，只能链式计算。

在实际工程应用中为了提高插补效率引入最大前瞻段数概念．最大前瞻段数Ｎ为迭代计算ｖｉ的最大次数．即当迭代次数超过Ｎ时将第ｉ＋Ｎ路径段末速设为零结束迭代求解过程．

### roadmap
- [ ] 速度前瞻-梯形规划算法
- [ ] 速度前瞻-s形规划算法-加速度置0
- [ ] 速度前瞻-s形规划算法-加速度置0， 动态规划优化。
- [ ] 速度前瞻-s形规划算法-加速度无缝衔接
- [ ] 

###### 右侧追加新规划
- 右侧追加
- 0 默认限速 （可以理解成极小值）
- 1 左侧限速，右侧无限速 （可以理解成前段加速）
- 2 右侧限速，左侧无限速 （可以理解成后段减速）
- 3 左侧强限速，右侧弱限速
- 4 右侧强限速，左侧弱限速


[0,0,3,0,2,0]
[0,0,3,0,2,x,0]
[0,0,3,0,2+,x+,0]

原来的端点速度向上松弛，更改标记成0，1，2，3，4。

- 遇到0，1，3，速度不变，停止回溯;
- 遇到2，向上松弛速度，继续回溯;
- 遇到4分3种情况
  - 更改标记成3，速度不变，停止回溯；
  - 更改标记成1，速度不变，停止回溯；
  - 更改标记成4，向上松弛速度，继续回溯.


##### 半边限速 

### 参考论文
#### 基于Look-Ahead技术的CNC轨迹规划的研究
哈尔滨工业大学李建华《基于Look-Ahead技术的CNC轨迹规划的研究》
##### 基于运动控制卡的PC数控进给速度前瞻控制 
刘青山高霖 
南京航空航天大学机电学院

#### 嵌入式数控系统速度前瞻规划算法研究
游达章

#### 连续轨迹的S型速度规划的研究
连续轨迹的S型速度规划的研究
王允航
哈尔滨工业大学
摘要：在当今的工业领域中,数控设备已经成为不可或缺的自动化设备之一,同时它的使用已经越来越普遍。随着加工产品复杂性的提高,对数控设备的精度要求也越来越高。为了保证其加工精度,数控机床的平稳运行就变的非常重要。本文通过对速度曲线的分析,发现速度曲线中存在一些相同变化趋势的速度点,这些速度点之间的波动给机床的加工造成了不必要的震动。为了消除掉这些震动,文中提出了一种应用曲线拟合算法的寻找同趋势速度坐标点的方法。该算法中利用趋势相同速度点之间的一些特性,确定算法处理的趋势段。之后采用一段大梯形曲线近似的方法,将这段趋势段整理为一段大的梯形速度曲线,同时将原有的位置信息映射到大的梯形速度曲线中。为了进一步平滑速度曲线,采用S型速度曲线和正弦速度曲线的上升段和下降段,来代替大梯形速度曲线的上升和下降段,进而消除了速度衔接处的速度波动,达到平滑机床进给速度的作用。通过应用这种算法对一些实际加工路径的仿真处理,我们发现在同趋势段中的速度波动明显减弱,相应的加速度波动也有所缓解,达到了一定的平滑效果,在速度衔接处平滑过渡消除了加加速度带来的机床震动。 
关键词：	速度规划;速度平滑;数控技术;S型速度;
专辑：	工程科技Ⅰ辑; 信息科技
专题：	金属学及金属工艺; 自动化技术
分类号：	TG659
导师：	李建刚;
学科专业：	控制科学与工程
硕士电子期刊出版信息：	年期：2012年第03期网络出版时间：2012-02-16——2012-03-15